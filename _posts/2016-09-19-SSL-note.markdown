---
layout: post
date: 2016-09-19 10:00:00 +0800
title: SSL Note
excerpt: SSL Note
categories:
  - blog
  - note
tags:
  - protocal
---

## SSL

### TLS Handshake (wireshake capture access https://mail.koal.com)

#### TLS Handshake - Client Hello

TLSv1 Record Layer: Handshake Protocol: Client Hello

- Content Type: Handshake (22) (0x16)
- Version: TLS 1.2 (0x0303)
- Length: 213 (0x00d5)
  - Handshake Protocol: Client Hello
  - Handshake Type: Client Hello (1) (0x01)
  - Length: 209 (0x0000d1)
  - Version: TLS 1.2 (0x0303)
  - Random
    - GMT Unix Time: (0x57e09129)
    - Random Bytes: (0x955cd91c3c76d3c9522452d468bb1b84c43509283a209d9eefc1f2c6) (16Bytes)
- Session ID Length: 0 (0x00)
  - Cipher Suites Length: 56
  - Cipher Suites (28 suites)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xc02c)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)
    - Cipher Suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384 (0x009f)
    - Cipher Suite: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256 (0x009e)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384 (0xc024)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 (0xc023)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 (0xc028)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 (0xc027)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA (0xc00a)
    - Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA (0xc009)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014)
    - Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)
    - Cipher Suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA (0x0039)
    - Cipher Suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA (0x0033)
    - Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)
    - Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (0x009c)
    - Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA256 (0x003d)
    - Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA256 (0x003c)
    - Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)
    - Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (0x002f)
    - Cipher Suite: TLS_RSA_WITH_3DES_EDE_CBC_SHA (0x000a)
    - Cipher Suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256 (0x006a)
    - Cipher Suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 (0x0040)
    - Cipher Suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA (0x0038)
    - Cipher Suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA (0x0032)
    - Cipher Suite: TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA (0x0013)
  - Compression Methods Length: 1 (0x01)
  - Compression Methods (1 method)
    - Compression Method: null (0) (0x00)
  - Extensions Length: 112 (0x0070)

<div class="alert alert-info" role="alert">
  <p>TLSv1层次：包括TLSv1类型为Handshake，TLSv1版本，TLSv1长度</p>
  <p>Handshake层次：包括Handshake类型为client hello，handshake长度，handshake tlsv1版本，时间戳 + 随机数，Session字段，压缩字段，扩展字段</p>
</div>

#### TLS Handshake - Server Hello

TLSv1 Record Layer: Handshake Protocol: Server Hello

- Content Type: Handshake (22) (0x16)
- Version: TLS 1.0 (0x0301)
- Length: 81 (0x0051)
- Handshake Protocol: Server Hello
  - Handshake Type: Server Hello (2) (0x02)
  - Length: 77 (0x0000d1)
  - Version: TLS 1.0 (0x0301)
  - Random
    - GMT Unix Time: (0x57e09129)
    - Random Bytes: (0x955cd91c3c76d3c9522452d468bb1b84c43509283a209d9eefc1f2c6) (16Bytes)
  - Session ID Length: 32
  - Session ID: 4d42823551b8195be188c2e9cc8fa27e580f0df6045ee9b1...
  - Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)
  - Compression Method: null (0x00)
  - Extensions Length: 5 (0x00)

<div class="alert alert-info" role="alert">
  <p>TLSv1层次：包括TLSv1类型为Handshake，服务端选定的TLSv1版本，TLSv1长度</p>
  <p>Handshake层次：包括Handshake类型为server hello，handshake长度，服务端选定的handshake tlsv1版本，时间戳 + 随机数，服务端生成的Session字段，服务端选定的算法，压缩字段，扩展字段</p>
</div>

#### Handshake Certificate + Multiple Handshake Message (Certificate Request + Server Hello Done)

TLSv1 Record Layer: Handshake Protocol: Certificate

- Content Type: Handshake (22)
- Version: TLS 1.0 (0x0301)
- Length: 3387
- Handshake Protocol: Certificate
  - Handshake Type: Certificate (11)
  - Length: 3383
  - Certificates Length: 3380
  - Certificates (3380 bytes)

<div class="alert alert-info" role="alert">
  <p>提供服务端证书</p>
</div>

TLSv1 Record Layer: Handshake Protocol: Multiple Handshake Messages

- Content Type: Handshake (22)
- Version: TLS 1.0 (0x0301)
- Length: 302
- Handshake Protocol: Certificate Request
  - Handshake Type: Certificate Request (13)
  - Length: 294
  - Certificate types count: 3
  - Certificate types (3 types)
  - Certificate type: RSA Sign (1)
  - Certificate type: DSS Sign (2)
  - Certificate type: ECDSA Sign (64)
  - Distinguished Names Length: 288
    - Distinguished Names (288 bytes)
- Handshake Protocol: Server Hello Done
- Handshake Type: Server Hello Done (14)
- Length: 0

<div class="alert alert-info" role="alert">
  <p>服务端发起客户端证书索取请求，包含对客户端证书用途要求，及对客户端证书上级颁发者要求</p>
</div>

#### Handshake Multiple Handshake Message(Certificate + Client Key Exchange + Certificate Verify) + Change Cipher Spec + Encrypted Handshake Message

TLSv1 Record Layer: Handshake Protocol: Multiple Handshake Messages

- Content Type: Handshake (22) (0x16)
- Version: TLS 1.0 (0x0301)
- Length: 2669
- Handshake Protocol: Certificate
  - Handshake Type: Certificate (11)
  - Length: 2269
  - Certificates Length: 2266
    - Certificates (2266 bytes)
- Handshake Protocol: Client Key Exchange
  - Handshake Type: Client Key Exchange (16)
  - Length: 258
  - RSA Encrypted PreMaster Secret
    - Encrypted PreMaster length: 256
    - Encrypted PreMaster: 3f5d2080ee8d55c4dc1f6caadac01f494522e5de7b6c468d...
- Handshake Protocol: Certificate Verify
  - Handshake Type: Certificate Verify (15)
  - Length: 130
  - Signature length: 128
  - Signature: c37bc051b439fc10061150163cded934c842917cef8ab37d...

<div class="alert alert-info" role="alert">
 <p>客户端发送客户端证书</p>
 <p>客户端发送加密数据</p>
 <p>客户端发送加密后数据</p>
</div>

#### Handshake Change Cipher Spec + Encrypted Handshake Message

TLSv1 Record Layer: Change Cipher Spec Protocol: Change Cipher Spec

- Content Type: Change Cipher Spec (20)
- Version: TLS 1.0 (0x0301)
- Length: 1
- Change Cipher Spec Message

TLSv1 Record Layer: Handshake Protocol: Encrypted Handshake Message

- Content Type: Handshake (22)
- Version: TLS 1.0 (0x0301)
- Length: 48
- Handshake Protocol: Encrypted Handshake Message

---

<table class="table table-bordered">
{% capture table %}

|\#handshake |client||server|
|---|---|:---:|---|
|client hello - client|- Key-C<br />- Cert-C<br />- Ca-C<br />+ Random-C (create)|-><br />Random-C<br />Support TLS version<br />Support Cipher<br />Support Compression|- Key-S<br />- Cert-S<br />- Ca-S|
|client hello - server|- Key-C<br />- Cert-C<br />- Ca-C<br />- Random-C||- Key-S<br />- Cert-S<br />- Ca-S<br />+ Random-C (accept)|
|server hello - server|- Key-C<br />- Cert-C<br />- Ca-C<br />- Random-C|<-<br />Random-S<br />Select TLS version<br />Select Cipher (Kx Au Enc Mac)<br />Select Compression|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C<br />+ Random-S (create)|
|server certificate - server|- Key-C<br />- Cert-C<br />- Ca-C<br />- Random-C<br />|<-<br />Cert-S|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
|server certificate request - server|- Key-C<br />- Cert-C<br />- Ca-C<br />- Random-C <br />|<-<br />Request Client Cert Type & Issue|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
|server server hello done - server|- Key-C<br />- Cert-C<br />- Ca-C<br />- Random-C <br />||- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
|server hello - client|- Key-C<br />- Cert-C<br />+ Cert-S (accept)<br />- Ca-C<br />- Random-C <br />+ Random-S (accept)||- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
||Server-Auth(Ca-C, Cert-S)|||
|client certificate - client|- Key-C<br />- Cert-C<br />- Cert-S<br />- Ca-C<br />- Random-C <br />- Random-S<br />|-><br />Cert-C|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
|client key exchange - client|- Key-C<br />- Cert-C<br />- Cert-S<br />- Ca-C<br />- Random-C <br />- Random-S<br />+ PreMasterKey (create)|-><br />E-PreMasterKey (Ex(PreMasterKey, Cert-S))|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
|client certificate verify - client|- Key-C<br />- Cert-C<br />- Cert-S<br />- Ca-C<br />- Random-C <br />- Random-S<br />- PreMasterKey<br />+ MasterKey (Mac(PreMasterKey, Random-C, Random-S))<br />+ Keyblock (Mac(MasterKey, Random-C, Random-S))<br />+ Signature (Au(MasterKey, Message, Key-C))|-><br />Signature|- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S|
||||Client-Auth(Ca-S, Cert-C)|
|client certificate & key exchange - server|- Key-C<br />- Cert-C<br />- Cert-S<br />- Ca-C<br />- Random-C <br />- Random-S<br />- PreMasterKey ()<br />||- Key-S<br />- Cert-S<br />- Ca-S<br />- Random-C <br />- Random-S<br />+ PreMasterKey (accept ~Ex(E-PreMasterKey, Key-S))+ MasterKey (Mac(PreMasterKey, Random-C, Random-S))<br />+ Keyblock (Mac(MasterKey, Random-C, Random-S))<br />Signature (accept)|
||||~Au(Signature, Cert-C)|
{% endcapture %}
{{ table | markdownify | remove: '<table>' | remove: '</table>' }}
</table>


## Reference

[in2eps](http://www.in2eps.com/fo-ssl/tk-fo-ssl-ex01.html)


